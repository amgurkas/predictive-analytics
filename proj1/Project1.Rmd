---
title: "Project1"
author: "Alyssa Gurkas"
date: "2025-06-25"
output: word_document
---
## Forecasting Residential Energy Usage for 2014

### Loading the R Packages
```{r load-libraries}
library(tidyverse)
library(lubridate)
library(readxl)
library(openxlsx)
library(forecast)
library(fpp2)
```

#### Loading the excel spreadsheet data
```{r load-data}
raw_data <- read_excel("ResidentialCustomerForecastLoad-624.xlsx")
```

#### Checking the Structure of the data
```{r eda-check-str}
str(raw_data)
```

```{r eda-na-missing}
dups <- raw_data |>  
  group_by_all() |>  
  filter(n() > 1) |>  
  ungroup()

missing <- colSums(is.na(raw_data))
```

```{r rem-na}
data <- raw_data |> 
  na.omit() |> 
  mutate(date=as.Date(paste0(`YYYY-MMM`,"-01"), format = "%Y-%b-%d")) |> 
  select(-`YYYY-MMM`)
```

```{r summarize-kwh}
# Summarize KWH values (min, max, mean, quantiles).
summary <- data |> 
  summarise(
    min = min(KWH),
    max = max(KWH),
    mean = mean(KWH),
    iqr = IQR(KWH),
    sd= sd(KWH)
  )

p <- c(0.25, 0.5, 0.75)
p_names <- map_chr(p, ~paste0(.x*100, "%"))
p_funs <- map(p, ~partial(quantile, probs = .x, na.rm = TRUE)) |>  
  set_names(nm = p_names)

map(p_funs, ~ .x(data$KWH)) |> as_tibble_row()
```

```{r calc-binwidth}
binwidth <- 3.5 * sd(data$KWH) / nrow(data)^(1/3)
```

```{r histo}
options(scipen=999)

ggplot(raw_data, aes(x = KWH)) +
  geom_histogram(alpha = 0.6, 
                 position = "identity", 
                 binwidth = binwidth) +
  geom_density(
    aes(y = ..density..* binwidth * nrow(data)), 
    alpha = 0.2, 
    color = "red") +
  labs(
    title = "Distribution of Energy Use",
    x = "Kilowatts per Hour", y = "Frequency") +
  theme_minimal()
```

```{r boxplot}
ggplot(data, aes(y=KWH)) + 
  geom_boxplot(fill="lightblue", color="darkblue") + 
  theme_minimal() +
  labs(title="Boxplot of Kilowatts per Hour", y="Kilowatts per Hour")
```

```{r}
ggplot(data, aes(x = `date`, y = KWH)) +
  geom_line(color = "blue") +
  theme_minimal() +
  labs(title = "Time Series of Energy Usage", x = "Date", y = "Kilowatts per Hour")
```
# insert sentence about slight increase over time.

```{r seasonal-patterns}
data_seasonal <- data |> 
  mutate(
    month = month(date),
    year = year(date)
  )

data_seasonal$month <- factor(month.abb[as.numeric(data_seasonal$month)],
                              levels = month.abb)

ggplot(data_seasonal, aes(x = month, y = KWH, group = year, color = as.factor(year))) +
  geom_line() +
  labs(
    title = "Seasonal Line Plot of Energy Usage",
    x = "Month",
    y = "Kilowatts per Hour",
    color = "Year"
  ) +
  theme_minimal()+
   theme(plot.title = element_text(hjust = 0.5))
```

```{r subseries-plot}
ggplot(data_seasonal, aes(x = year, y = KWH)) +
  geom_line() +
  facet_wrap(~month)+
  labs(
    title = "Seasonal Subseries Plot of Energy Usage",
    x = "Year",
    y = "Kilowatts per Hour",
    color = "Year"
  ) +
  theme_minimal()+
   theme(plot.title = element_text(hjust = 0.5))
```

4. Decompose the Time Series
Using STL decomposition (Seasonal-Trend decomposition using Loess) or classical decomposition:
Extract and visualize trend, seasonality, and residual components.
Look for changing seasonal patterns or non-linear trends.

```{r convert-ts}
start_year <- year(min(data$date))
start_month <- month(min(data$date))

ts_data <- ts(data$KWH,
              start = c(start_year, start_month),
              frequency = 12)
```

```{r ts-decomp}
decomposed <- decompose(ts_data, type = "additive")
plot(decomposed)
```

```{r stl-decomp}
stl <- stl(ts_data, s.window = "periodic")
plot(stl)
```

```{r stl-forecast}
stl |>  seasadj() |>  naive() |> 
  autoplot() + ylab("Energy Usage in KWH") +
  ggtitle("Forecasts of Seasonally Adjusted Energy Data")
```

```{r 2014-forecast}
model <- ets(ts_data)
forecast_2014 <- forecast(model, h = 12)
autoplot(forecast_2014)+
ylab("Energy Usage in KWH") +
ggtitle("Forecasts for 2014 Energy Data")
```

```{r produce-kwh-2014-df}
kwh_2014 <- tibble(
  date = seq(ymd("2014-01-01"), by = "month", length.out = 12),
  forecast_kwh = as.numeric(forecast_2014$mean)
) |> 
mutate(
  CaseSequence=row_number() + 924,
  "YYYY-MMM"= format(date, "%Y-%b")
) |> 
  rename("KWH"="forecast_kwh") |> 
select(CaseSequence,`YYYY-MMM`,`KWH`)
```

```{r produce-excel}
wb <- loadWorkbook("ResidentialCustomerForecastLoad-624.xlsx")
# addWorksheet(wb, "KWH-2014-Forecast") 
# writeData(wb, "KWH-2014-Forecast", kwh_2014)
# saveWorkbook(wb, "ResidentialCustomerForecastLoad-624.xlsx", overwrite = TRUE)
```